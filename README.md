# Nodejs-OpenTSDB
Catchpoint Integration with OpenTSDB
---
OpenTSDB is a highly scalable Time Series Database built on top of HBase. It is perfect for storing high volume data generated by Synthetic Tests.

This integration relies on a NodeJS script that runs every 15 minutes to pull raw synthetic test performance data from Catchpoint's REST API and store it in OpenTSDB. Once the data has been successfully inserted, it can be viewed and analyzed using any compatible analytics tool (e.g. Grafana). 

**Note: Right now, it has ability to pull data from one division per script setup**

## Prerequisites
1. NodeJS v16.x
2. [OpenTSDB v2.4.x](http://opentsdb.net/)
3. Catchpoint account with a REST API consumer

## Installation and Configuration
1. Copy the NodeJS folder to your machine
2. Run npm install in the directory /opentsdb-nodejs

### Configuration
1. In the "config_catchpoint.js" file under config sub-directory, enter your [Catchpoint API consumer key and secret](https://portal.catchpoint.com/ui/Content/Administration/ApiDetail.aspx)
2. In the tests object of the "config_catchpoint.js" file, enter the Test IDs you want to pull the data for in an array format. Please ensure to enter only the Test ID in the array belonging to the respective Test Type.

*Example:*

---
    tests: 
    {
        web: [142613,142614,142615,142616],
        transaction: [142602,142603],
        api: [142683,142689,155444],
        ping: [142600],
        traceroute: [142607,142608,142609],
        dns: [942639,142640,142641],
        websocket: [842700],
        smtp: [142604]
    }

---
3. In the "config_tsdb.js" file, enter your openTSDB hostname with http scheme and the port number.

## How to run
The script can be run either in the terminal or as a cronjob. Run frequency of 15 minutes can be used as it will call the GET:LastRaw API which provides last 15 minutes of raw performance data for the specified Test IDs.

- In the /opentsdb-nodejs directory, run `node insert_db.js` after uncommenting the `var interval=setInterval(run,900000)` and commenting out the `run()` line in the same file

**or**

- Create a cronjob to run the "insert_db.js" script every 15 minutes.

*Example crontab entry, if the "insert_db.js" file resides in /usr/local/bin/*

`*/15 * * * * cd /usr/local/bin/ && node /usr/local/bin/insert_db.js > /usr/local/bin/logs/cronlog.log 2>&1`

**Note: Ensure that TSD is running along with HBase**

## File Structure

    opentsdb-nodejs/
    ├── auth_handler.js       ## Contains APIs related to authentication       
    ├── config
    | ├── config_catchpoint.js## Configuration file for Catchpoint 
    | ├── config_tsdb.js    ## Configuration file for OpenTSDB
    ├── logs
    | ├── info
    | |  ├── info.log         ## Contains informational logs. File name will be based on date of execution
    | ├── error
    | |  ├── error.log        ## Contains error logs. File name will be based on date of execution          
    ├── utils
    | ├── logger.js           ## logger utility
    ├──package.json           ## project dependencies
    └── insert_db.js          ## main file


The data stored in OpenTSDB can be viewed via its Web UI or we can connect OpenTSDB to an analytics tool such as Grafana and [explore the data](https://grafana.com/docs/grafana/latest/datasources/graphite/).
